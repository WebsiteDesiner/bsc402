<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CZ402 - Charity Payment Protocol</title>
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="logo.jpg">
    <link rel="apple-touch-icon" href="logo.jpg">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            padding: 20px 0;
            border-bottom: 1px solid #e5e5e5;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo-image {
            height: 45px;
            width: auto;
            max-width: 180px;
            object-fit: contain;
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .logo-image:hover {
            transform: scale(1.05);
        }

        .nav {
            display: flex;
            gap: 30px;
        }

        .nav a {
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .nav a:hover {
            color: #1a1a1a;
        }

        .x-link {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000000;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            height: 36px;
            min-width: 36px;
        }

        .x-icon {
            width: 20px;
            height: 20px;
            display: block;
        }

        .x-link:hover {
            background: #333333;
            transform: translateY(-1px);
        }

        .connect-btn {
            padding: 10px 20px;
            background: #8B5CF6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connect-btn:hover {
            background: #7C3AED;
            transform: translateY(-1px);
        }

        /* Hero */
        .hero {
            text-align: center;
            padding: 30px 0;
        }

        .hero h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        .hero .subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .hero-art {
            margin: 20px 0;
            text-align: center;
        }

        .hero-art-image {
            max-width: 100%;
            height: auto;
            max-height: 200px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .charity-address {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 12px;
            font-family: monospace;
            font-size: 14px;
        }

        .charity-address .label {
            color: #92400E;
            font-weight: 600;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin: 30px 0;
        }

        /* Donation Card */
        .donation-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 16px;
            padding: 25px;
        }

        .donation-card h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        /* Balance Display */
        .balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .balance-item {
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
        }

        .balance-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .balance-value {
            font-size: 32px;
            font-weight: 700;
        }

        .balance-value.bsc {
            color: #8B5CF6;
        }

        .balance-value.cz {
            color: #F59E0B;
        }

        /* Amount Input */
        .amount-section {
            margin-bottom: 30px;
        }

        .amount-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            display: block;
        }

        .amount-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .amount-input {
            width: 100%;
            padding: 16px;
            padding-right: 80px;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            transition: border-color 0.2s;
        }

        .amount-input:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .amount-suffix {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 16px;
            font-weight: 500;
        }

        /* Quick Amounts */
        .quick-amounts {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            border-color: #8B5CF6;
            color: #8B5CF6;
        }

        .quick-btn.active {
            background: #8B5CF6;
            color: white;
            border-color: #8B5CF6;
        }

        /* Slider */
        .slider-container {
            margin-bottom: 30px;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: #e5e5e5;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #8B5CF6;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #8B5CF6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Exchange Preview */
        .exchange-preview {
            padding: 20px;
            background: #F0FDF4;
            border: 1px solid #86EFAC;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .exchange-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exchange-label {
            color: #166534;
            font-size: 14px;
        }

        .exchange-value {
            font-size: 24px;
            font-weight: 700;
            color: #166534;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-approve {
            background: #f3f4f6;
            color: #6b7280;
        }

        .btn-approve.ready {
            background: #8B5CF6;
            color: white;
        }

        .btn-donate {
            background: #F59E0B;
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Stats Sidebar */
        .stats-sidebar {
            position: sticky;
            top: 20px;
        }

        .stats-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .stats-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 16px;
        }

        /* Info Card */
        .info-card {
            background: #F3F4F6;
            border-radius: 12px;
            padding: 20px;
        }

        .info-card h4 {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .info-card p {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        .info-card a {
            color: #8B5CF6;
            text-decoration: none;
            font-weight: 500;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin: 20px 0;
            }
            
            .hero {
                padding: 20px 0;
            }
            
            .hero h1 {
                font-size: 28px;
            }
            
            .hero .subtitle {
                font-size: 14px;
            }
            
            .hero-art-image {
                max-height: 150px;
            }
            
            .balance-display {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo-image {
                height: 35px;
                max-width: 150px;
            }
            
            .nav {
                display: none;
            }
            
            .donation-card {
                padding: 20px;
            }
            
            .stats-card {
                padding: 15px;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e5e5;
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 30px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #e5e5e5;
        }

        .modal-body {
            padding: 30px;
        }

        .protocol-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #8B5CF6, #F59E0B);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        .section-content {
            color: #6b7280;
            line-height: 1.8;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 20px;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .feature-desc {
            font-size: 14px;
            color: #6b7280;
        }

        .flow-diagram {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .flow-step:last-child {
            margin-bottom: 0;
        }

        .flow-number {
            width: 32px;
            height: 32px;
            background: #8B5CF6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .flow-text {
            color: #4b5563;
        }

        .code-block {
            background: #1a1a1a;
            color: #10b981;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .highlight {
            color: #8B5CF6;
            font-weight: 600;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #10B981;
        }

        .toast.error {
            border-left: 4px solid #EF4444;
        }

        .toast.info {
            border-left: 4px solid #3B82F6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <img src="logo.jpg" alt="BSC402 Ã— CZ402" class="logo-image" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                </div>
                <nav class="nav">
                    <a href="#" onclick="openModal('protocol'); return false;">Protocol</a>
                    <a href="#" onclick="openModal('stats'); return false;">Stats</a>
                    <a href="#" onclick="openModal('docs'); return false;">Docs</a>
                    <a href="https://pancakeswap.finance" target="_blank">Liquidity</a>
                    <a href="https://x.com/bsc402payment" target="_blank" class="x-link">
                        <img src="X.png" alt="X" class="x-icon">
                    </a>
                </nav>
                <button class="connect-btn" id="connect-btn" onclick="connectWallet()">
                    Connect Wallet
                </button>
            </div>
        </header>

        <section class="hero">
            <h1>402 Charity Payment Protocol</h1>
            <p class="subtitle">100% Fair Launch Â· No Team Reserve Â· Community Driven</p>
            <div class="hero-art">
                <img src="ART.jpg" alt="402 Charity Protocol Art" class="hero-art-image">
            </div>
            <div class="charity-address">
                <span class="label">CZ Charity:</span>
                <span>0x28816C4c4792467390C90E5b426F198570E29307</span>
            </div>
        </section>

        <div class="main-grid">
            <div class="donation-card">
                <h2>Make a Donation</h2>
                
                <div class="balance-display">
                    <div class="balance-item">
                        <div class="balance-label">BSC402 Balance</div>
                        <div class="balance-value bsc" id="bsc402-balance">0.00</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">CZ402 Balance</div>
                        <div class="balance-value cz" id="cz402-balance">0.00</div>
                    </div>
                </div>

                <div class="amount-section">
                    <label class="amount-label">Amount to Donate</label>
                    <div class="amount-input-wrapper">
                        <input type="number" class="amount-input" id="amount-input" placeholder="0" min="10">
                        <span class="amount-suffix">BSC402</span>
                    </div>
                    
                    <div class="quick-amounts">
                        <button class="quick-btn" onclick="setAmount(10)">10</button>
                        <button class="quick-btn" onclick="setAmount(100)">100</button>
                        <button class="quick-btn" onclick="setAmount(500)">500</button>
                        <button class="quick-btn" onclick="setAmount(1000)">1K</button>
                        <button class="quick-btn" onclick="setMaxAmount()">MAX</button>
                    </div>
                    
                    <div class="slider-container">
                        <input type="range" class="slider" id="amount-slider" min="10" max="1000" value="10">
                    </div>
                </div>

                <div class="exchange-preview">
                    <div class="exchange-row">
                        <span class="exchange-label">You will receive</span>
                        <span class="exchange-value" id="receive-amount">1 CZ402</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-approve" id="approve-btn" onclick="approve()" disabled>
                        Approve BSC402
                    </button>
                    <button class="btn btn-donate" id="donate-btn" onclick="donate()" disabled>
                        Donate
                    </button>
                </div>
            </div>

            <div class="stats-sidebar">
                <div class="stats-card">
                    <h3>Protocol Stats</h3>
                    <div class="stat-item">
                        <span class="stat-label">Total Raised</span>
                        <span class="stat-value" id="total-raised">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Donors</span>
                        <span class="stat-value" id="total-donors">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CZ402 Minted</span>
                        <span class="stat-value" id="total-minted">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Your Donations</span>
                        <span class="stat-value" id="user-donations">0</span>
                    </div>
                </div>

                <div class="info-card">
                    <h4>Add Liquidity</h4>
                    <p>
                        Provide liquidity on PancakeSwap to earn trading fees. 
                        Create CZ402/BNB or CZ402/USDT pairs.
                    </p>
                    <a href="https://pancakeswap.finance/liquidity" target="_blank">
                        Go to PancakeSwap â†’
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Title</h2>
                <button class="modal-close" onclick="closeModal()">âœ•</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script>
        // åˆçº¦åœ°å€é…ç½®
        const BSC402_ADDRESS = '0x78d122dcc1ad141702cf473e759a5075bd9f4444';
        const CZ402_ADDRESS = '0xec007E62987FE5B5CC7D5f3f56eC3A4D2bed1C33';
        
        // æ ‡å‡† ERC20 ABI (ç”¨äº BSC402)
        const BSC402_ABI = [
            {
                "inputs": [{"name": "spender", "type": "address"}, {"name": "amount", "type": "uint256"}],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "owner", "type": "address"}, {"name": "spender", "type": "address"}],
                "name": "allowance",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        
        // CZ402 åˆçº¦ ABI (å®Œç¾åŒ¹é… CZ402-Simple.sol)
        const CZ402_ABI = [
            {
                "inputs": [{"name": "amount", "type": "uint256"}],
                "name": "donate",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"name": "donor", "type": "address"}],
                "name": "getDonorInfo",
                "outputs": [
                    {"name": "donated", "type": "uint256"},
                    {"name": "times", "type": "uint256"},
                    {"name": "cz402Balance", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getStats",
                "outputs": [
                    {"name": "raised", "type": "uint256"},
                    {"name": "donors", "type": "uint256"},
                    {"name": "donations", "type": "uint256"},
                    {"name": "minted", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalDonated",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalDonors",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "donationCount",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "address", "type": "address"}],
                "name": "donorAmount",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "address", "type": "address"}],
                "name": "donorTimes",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let web3;
        let userAccount;
        let bsc402Contract;
        let cz402Contract;
        let userBSC402Balance = 0;

        // Initialize
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                
                // æ£€æŸ¥æ˜¯å¦é…ç½®äº†åˆçº¦åœ°å€
                if (!BSC402_ADDRESS || !CZ402_ADDRESS) {
                    return;
                }
                
                // åˆå§‹åŒ–åˆçº¦
                bsc402Contract = new web3.eth.Contract(BSC402_ABI, BSC402_ADDRESS);
                cz402Contract = new web3.eth.Contract(CZ402_ABI, CZ402_ADDRESS);
                
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                loadStats();
                setInterval(loadStats, 15000); // æ¯15ç§’æ›´æ–°
                
                // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    await handleConnect(accounts);
                }
                
                // ç›‘å¬è´¦æˆ·å˜åŒ–
                window.ethereum.on('accountsChanged', async (accounts) => {
                    if (accounts.length > 0) {
                        await handleConnect(accounts);
                    } else {
                        userAccount = null;
                        document.getElementById('connect-btn').textContent = 'Connect Wallet';
                    }
                });
                
                // ç›‘å¬ç½‘ç»œå˜åŒ–
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });
                
                // Setup event listeners
                setupEventListeners();
                
            } else {
                showToast('è¯·å®‰è£… MetaMask é’±åŒ…', 'error');
            }
        });

        function setupEventListeners() {
            // Input change
            document.getElementById('amount-input').addEventListener('input', function(e) {
                const value = parseFloat(e.target.value) || 0;
                updateSlider(value);
                updatePreview(value);
                
                // æ£€æŸ¥ä½™é¢
                if (userBSC402Balance > 0 && value > userBSC402Balance) {
                    showToast('ä½™é¢ä¸è¶³', 'error');
                }
            });
            
            // Slider change
            document.getElementById('amount-slider').addEventListener('input', function(e) {
                const value = parseFloat(e.target.value);
                document.getElementById('amount-input').value = value;
                updatePreview(value);
            });
        }

        async function connectWallet() {
            try {
                // è·å–å½“å‰ç½‘ç»œ
                const chainId = await web3.eth.getChainId();
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºBSCä¸»ç½‘
                if (chainId !== 56) {
                    showToast('è¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘ (Chain ID: 56)', 'error');
                    
                    // å°è¯•åˆ‡æ¢åˆ°BSCä¸»ç½‘
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }], // 56 çš„åå…­è¿›åˆ¶
                        });
                    } catch (switchError) {
                        // å¦‚æœæ²¡æœ‰æ·»åŠ BSCç½‘ç»œï¼Œæ·»åŠ å®ƒ
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x38',
                                        chainName: 'Binance Smart Chain',
                                        nativeCurrency: {
                                            name: 'BNB',
                                            symbol: 'BNB',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                        blockExplorerUrls: ['https://bscscan.com']
                                    }]
                                });
                            } catch (addError) {
                                showToast('æ·»åŠ  BSC ç½‘ç»œå¤±è´¥', 'error');
                                return;
                            }
                        }
                    }
                }
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                await handleConnect(accounts);
                showToast('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
            } catch (error) {
                showToast('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function handleConnect(accounts) {
            userAccount = accounts[0];
            document.getElementById('connect-btn').textContent = 
                userAccount.slice(0, 6) + '...' + userAccount.slice(-4);
            
            await loadBalances();
            await loadUserStats();
        }

        async function loadBalances() {
            if (!userAccount || !bsc402Contract || !cz402Contract) return;
            
            try {
                // Get BSC402 balance
                const bsc402Balance = await bsc402Contract.methods.balanceOf(userAccount).call();
                userBSC402Balance = parseFloat(web3.utils.fromWei(bsc402Balance, 'ether'));
                document.getElementById('bsc402-balance').textContent = userBSC402Balance.toFixed(2);
                
                // Get CZ402 balance
                const cz402Balance = await cz402Contract.methods.balanceOf(userAccount).call();
                document.getElementById('cz402-balance').textContent = 
                    parseFloat(web3.utils.fromWei(cz402Balance, 'ether')).toFixed(2);
                
                // Update slider max based on balance
                const slider = document.getElementById('amount-slider');
                if (userBSC402Balance > 0) {
                    slider.max = Math.floor(userBSC402Balance);
                }
                
                // Check allowance
                const allowance = await bsc402Contract.methods.allowance(userAccount, CZ402_ADDRESS).call();
                const allowanceAmount = parseFloat(web3.utils.fromWei(allowance, 'ether'));
                
                if (allowanceAmount >= 10) { // è‡³å°‘æˆæƒ10ä¸ª
                    document.getElementById('approve-btn').textContent = 'âœ“ Approved';
                    document.getElementById('approve-btn').disabled = true;
                    document.getElementById('approve-btn').classList.remove('ready');
                    document.getElementById('donate-btn').disabled = false;
                } else {
                    document.getElementById('approve-btn').disabled = false;
                    document.getElementById('approve-btn').classList.add('ready');
                    document.getElementById('donate-btn').disabled = true;
                }
            } catch (error) {
                console.error('Error loading balances:', error);
                showToast('åŠ è½½ä½™é¢å¤±è´¥', 'error');
            }
        }

        async function loadStats() {
            if (!cz402Contract) return;
            
            try {
                const stats = await cz402Contract.methods.getStats().call();
                
                document.getElementById('total-raised').textContent = 
                    Math.floor(parseFloat(web3.utils.fromWei(stats.raised, 'ether'))).toLocaleString();
                document.getElementById('total-donors').textContent = stats.donors;
                document.getElementById('total-minted').textContent = 
                    Math.floor(parseFloat(web3.utils.fromWei(stats.minted, 'ether'))).toLocaleString();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUserStats() {
            if (!userAccount || !cz402Contract) return;
            
            try {
                const info = await cz402Contract.methods.getDonorInfo(userAccount).call();
                const donatedAmount = parseFloat(web3.utils.fromWei(info.donated, 'ether'));
                document.getElementById('user-donations').textContent = 
                    Math.floor(donatedAmount).toLocaleString();
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        function setAmount(amount) {
            if (userBSC402Balance > 0 && amount > userBSC402Balance) {
                showToast('ä½™é¢ä¸è¶³: ' + userBSC402Balance.toFixed(2) + ' BSC402', 'error');
                return;
            }
            document.getElementById('amount-input').value = amount;
            updateSlider(amount);
            updatePreview(amount);
        }

        function setMaxAmount() {
            if (!userAccount) {
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            if (userBSC402Balance < 10) {
                showToast('ä½™é¢ä¸è¶³ï¼Œæœ€å°‘éœ€è¦ 10 BSC402', 'error');
                return;
            }
            const max = Math.floor(userBSC402Balance);
            setAmount(max);
        }

        function updateSlider(value) {
            const slider = document.getElementById('amount-slider');
            if (value <= parseFloat(slider.max)) {
                slider.value = value;
            }
        }

        function updatePreview(amount) {
            const cz402Amount = amount / 10; // 10:1 ratio
            document.getElementById('receive-amount').textContent = 
                cz402Amount.toFixed(1) + ' CZ402';
        }

        async function approve() {
            if (!userAccount) {
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            
            try {
                showToast('æ­£åœ¨æˆæƒ BSC402...', 'info');
                
                // æˆæƒæœ€å¤§å€¼
                const maxAmount = '115792089237316195423570985008687907853269984665640564039457584007913129639935';
                
                const tx = await bsc402Contract.methods.approve(CZ402_ADDRESS, maxAmount)
                    .send({ from: userAccount });
                
                showToast('æˆæƒæˆåŠŸï¼', 'success');
                await loadBalances();
            } catch (error) {
                console.error('Approval error:', error);
                showToast('æˆæƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function donate() {
            const amount = document.getElementById('amount-input').value;
            if (!amount || amount < 10) {
                showToast('æœ€å°‘æèµ  10 BSC402', 'error');
                return;
            }
            
            if (amount > userBSC402Balance) {
                showToast('ä½™é¢ä¸è¶³', 'error');
                return;
            }
            
            try {
                showToast('æ­£åœ¨å¤„ç†æèµ ...', 'info');
                
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                
                // ä¼°ç®— Gas
                const gasEstimate = await cz402Contract.methods.donate(amountWei)
                    .estimateGas({ from: userAccount });
                
                const tx = await cz402Contract.methods.donate(amountWei).send({
                    from: userAccount,
                    gas: Math.floor(gasEstimate * 1.2) // æ·»åŠ 20%ä½™é‡
                });
                
                showToast(`âœ… æˆåŠŸï¼å·²æèµ  ${amount} BSC402ï¼Œè·å¾— ${amount/10} CZ402`, 'success');
                
                // Reset and reload
                document.getElementById('amount-input').value = '';
                document.getElementById('amount-slider').value = 10;
                updatePreview(0);
                await loadBalances();
                await loadStats();
                await loadUserStats();
            } catch (error) {
                console.error('Transaction error:', error);
                if (error.message.includes('insufficient funds')) {
                    showToast('BNBä¸è¶³ï¼Œæ— æ³•æ”¯ä»˜æ‰‹ç»­è´¹', 'error');
                } else {
                    showToast('äº¤æ˜“å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        function showToast(message, type) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Modal Functions
        function openModal(type) {
            const modal = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            switch(type) {
                case 'protocol':
                    title.textContent = '402 Charity Payment Protocol';
                    body.innerHTML = getProtocolContent();
                    break;
                case 'stats':
                    title.textContent = 'Protocol Statistics';
                    body.innerHTML = getStatsContent();
                    break;
                case 'docs':
                    title.textContent = 'Documentation';
                    body.innerHTML = getDocsContent();
                    break;
            }
            
            modal.classList.add('active');
        }

        function closeModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('modal-overlay').classList.remove('active');
            }
        }

        function getProtocolContent() {
            return `
                <div class="protocol-badge">
                    BSC402 Ã— FOURMEME Ã— CZ Charity Payment
                </div>
                
                <div class="section">
                    <h3 class="section-title">åˆ›æ–°åè®®ä»‹ç»</h3>
                    <p class="section-content">
                        402æ…ˆå–„æ”¯ä»˜åè®®æ˜¯ä¸€ä¸ªé©å‘½æ€§çš„åŒºå—é“¾æ…ˆå–„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡FourMemeé¡¹ç›®éƒ¨ç½²çš„BSC402ä»£å¸ä½œä¸ºæ”¯ä»˜åª’ä»‹ï¼Œ
                        å®ç°é€æ˜ã€é«˜æ•ˆçš„æ…ˆå–„æèµ ã€‚æ‰€æœ‰æèµ çš„BSC402ä»£å¸100%è½¬å…¥CZæ…ˆå–„åœ°å€ï¼Œæèµ è€…è·å¾—CZ402å¥–åŠ±ä»£å¸ä½œä¸ºè´¡çŒ®è¯æ˜ã€‚
                    </p>
                </div>

                <div class="section">
                    <h3 class="section-title">æ ¸å¿ƒç‰¹ç‚¹</h3>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ”’</div>
                            <div class="feature-title">100% Fair Launch</div>
                            <div class="feature-desc">æ— é¢„æŒ–ã€æ— å›¢é˜Ÿé¢„ç•™ï¼Œæ‰€æœ‰ä»£å¸é€šè¿‡æèµ äº§ç”Ÿ</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ’œ</div>
                            <div class="feature-title">BSC402æ”¯ä»˜</div>
                            <div class="feature-desc">ä½¿ç”¨FourMemeç”Ÿæ€ä»£å¸BSC402ä½œä¸ºå”¯ä¸€æ”¯ä»˜æ–¹å¼</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ¯</div>
                            <div class="feature-title">é€æ˜æèµ </div>
                            <div class="feature-desc">æ‰€æœ‰BSC402ç›´æ¥è½¬å…¥CZæ…ˆå–„åœ°å€ï¼Œé“¾ä¸Šå¯æŸ¥</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">âœ¨</div>
                            <div class="feature-title">CZ402å¥–åŠ±</div>
                            <div class="feature-desc">10:1æ¯”ä¾‹è·å¾—CZ402ä»£å¸ï¼Œå¯äº¤æ˜“å¯æä¾›æµåŠ¨æ€§</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">åè®®æµç¨‹</h3>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <span class="flow-number">1</span>
                            <span class="flow-text">æŒæœ‰BSC402ä»£å¸ï¼ˆFourMemeé¡¹ç›®ä»£å¸ï¼‰</span>
                        </div>
                        <div class="flow-step">
                            <span class="flow-number">2</span>
                            <span class="flow-text">é€šè¿‡402åè®®æèµ BSC402</span>
                        </div>
                        <div class="flow-step">
                            <span class="flow-number">3</span>
                            <span class="flow-text">BSC402è‡ªåŠ¨è½¬å…¥CZæ…ˆå–„åœ°å€</span>
                        </div>
                        <div class="flow-step">
                            <span class="flow-number">4</span>
                            <span class="flow-text">è·å¾—CZ402å¥–åŠ±ä»£å¸ï¼ˆ10:1æ¯”ä¾‹ï¼‰</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">CZæ…ˆå–„åœ°å€</h3>
                    <div class="code-block">
                        0x28816C4c4792467390C90E5b426F198570E29307
                    </div>
                    <p class="section-content">
                        æ‰€æœ‰æèµ çš„BSC402ä»£å¸å°†100%è½¬å…¥æ­¤åœ°å€ï¼Œå®Œå…¨é€æ˜ï¼Œé“¾ä¸Šå¯éªŒè¯ã€‚
                    </p>
                </div>
            `;
        }

        function getStatsContent() {
            return `
                <div class="section">
                    <h3 class="section-title">å®æ—¶ç»Ÿè®¡æ•°æ®</h3>
                    <p class="section-content">
                        åè®®è¿è¡Œä»¥æ¥çš„æ‰€æœ‰æ•°æ®å®Œå…¨é€æ˜ï¼Œå®æ—¶æ›´æ–°ï¼Œé“¾ä¸Šå¯æŸ¥ã€‚
                    </p>
                </div>

                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ’°</div>
                        <div class="feature-title">æ€»æèµ é‡</div>
                        <div class="feature-desc">ç´¯è®¡æèµ çš„BSC402æ•°é‡</div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ‘¥</div>
                        <div class="feature-title">æèµ è€…æ•°é‡</div>
                        <div class="feature-desc">å‚ä¸æèµ çš„ç‹¬ç«‹åœ°å€æ•°</div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ</div>
                        <div class="feature-title">CZ402å‘è¡Œé‡</div>
                        <div class="feature-desc">å·²é“¸é€ çš„CZ402æ€»é‡</div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ“Š</div>
                        <div class="feature-title">æèµ æ¬¡æ•°</div>
                        <div class="feature-desc">ç´¯è®¡æèµ äº¤æ˜“æ•°</div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">æ•°æ®é€æ˜æ€§</h3>
                    <p class="section-content">
                        æ‰€æœ‰æ•°æ®å‡å¯é€šè¿‡æ™ºèƒ½åˆçº¦ç›´æ¥æŸ¥è¯¢ï¼Œç¡®ä¿å®Œå…¨çš„é€æ˜åº¦å’Œå¯éªŒè¯æ€§ã€‚
                        æ¯ç¬”æèµ éƒ½ä¼šäº§ç”Ÿé“¾ä¸Šè®°å½•ï¼Œæ°¸ä¹…ä¿å­˜åœ¨åŒºå—é“¾ä¸Šã€‚
                    </p>
                </div>

                <div class="section">
                    <h3 class="section-title">æŸ¥è¯¢æ–¹æ³•</h3>
                    <div class="code-block">
                        // è·å–ç»Ÿè®¡æ•°æ®
                        contract.getStats()
                        
                        // æŸ¥è¯¢ä¸ªäººæèµ ä¿¡æ¯
                        contract.getDonorInfo(address)
                    </div>
                </div>
            `;
        }

        function getDocsContent() {
            return `
                <div class="section">
                    <h3 class="section-title">å¿«é€Ÿå¼€å§‹</h3>
                    <p class="section-content">
                        <span class="highlight">BSC402 Ã— FOURMEME Ã— CZ Charity Payment</span> æ˜¯åŸºäºBSCé“¾çš„åˆ›æ–°æ…ˆå–„åè®®ã€‚
                        é€šè¿‡FourMemeé¡¹ç›®éƒ¨ç½²çš„BSC402ä»£å¸ä½œä¸ºæ”¯ä»˜åª’ä»‹ï¼Œå®ç°å»ä¸­å¿ƒåŒ–çš„æ…ˆå–„æèµ ã€‚
                    </p>
                </div>

                <div class="section">
                    <h3 class="section-title">å¦‚ä½•å‚ä¸</h3>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <span class="flow-number">1</span>
                            <span class="flow-text"><strong>è·å–BSC402</strong> - ä»FourMemeé¡¹ç›®è·å–BSC402ä»£å¸</span>
                        </div>
                        <div class="flow-step">
                            <span class="flow-number">2</span>
                            <span class="flow-text"><strong>è¿æ¥é’±åŒ…</strong> - ä½¿ç”¨MetaMaskè¿æ¥BSCç½‘ç»œ</span>
                        </div>
                        <div class="flow-step">
                            <span class="flow-number">3</span>
                            <span class="flow-text"><strong>æˆæƒä»£å¸</strong> - é¦–æ¬¡ä½¿ç”¨éœ€è¦æˆæƒBSC402</span>
                        </div>
                        <div class="flow-step">
                            <span class="flow-number">4</span>
                            <span class="flow-text"><strong>æ‰§è¡Œæèµ </strong> - è¾“å…¥é‡‘é¢å¹¶ç¡®è®¤äº¤æ˜“</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">æŠ€æœ¯è§„æ ¼</h3>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <div class="feature-title">ç½‘ç»œ</div>
                            <div class="feature-desc">Binance Smart Chain (BSC)</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-title">æ”¯ä»˜ä»£å¸</div>
                            <div class="feature-desc">BSC402 (FourMeme402)</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-title">å¥–åŠ±ä»£å¸</div>
                            <div class="feature-desc">CZ402</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-title">å…‘æ¢æ¯”ä¾‹</div>
                            <div class="feature-desc">10 BSC402 = 1 CZ402</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-title">æœ€å°æèµ </div>
                            <div class="feature-desc">10 BSC402</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-title">æœ€å¤§ä¾›åº”</div>
                            <div class="feature-desc">1,000,000,000 CZ402</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">æ™ºèƒ½åˆçº¦</h3>
                    <div class="code-block">
                        // BSC402ä»£å¸åœ°å€ï¼ˆFourMeme402ï¼‰
                        BSC402: 0x...
                        
                        // CZ402æ…ˆå–„ä»£å¸åœ°å€
                        CZ402: 0x...
                        
                        // CZæ…ˆå–„æ¥æ”¶åœ°å€
                        CZ_ADDRESS: 0x28816C4c4792467390C90E5b426F198570E29307
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">æµåŠ¨æ€§æä¾›</h3>
                    <p class="section-content">
                        è·å¾—CZ402åï¼Œå¯ä»¥åœ¨PancakeSwapæä¾›æµåŠ¨æ€§ï¼Œèµšå–äº¤æ˜“æ‰‹ç»­è´¹ï¼š
                    </p>
                    <ul style="margin-left: 20px; color: #6b7280; line-height: 1.8;">
                        <li>åˆ›å»ºCZ402/BNBäº¤æ˜“å¯¹</li>
                        <li>åˆ›å»ºCZ402/USDTäº¤æ˜“å¯¹</li>
                        <li>åˆ›å»ºCZ402/BSC402äº¤æ˜“å¯¹</li>
                        <li>èµšå–0.25%äº¤æ˜“æ‰‹ç»­è´¹</li>
                    </ul>
                </div>

                <div class="section">
                    <h3 class="section-title">å®‰å…¨å®¡è®¡</h3>
                    <p class="section-content">
                        åˆçº¦ä»£ç å¼€æºï¼Œç»è¿‡ç¤¾åŒºå®¡æŸ¥ã€‚æ‰€æœ‰åŠŸèƒ½é€æ˜å¯æŸ¥ï¼Œæ— åé—¨ï¼Œæ— Ownerç‰¹æƒã€‚
                        æèµ åœ°å€ç¡¬ç¼–ç åœ¨åˆçº¦ä¸­ï¼Œæ— æ³•ä¿®æ”¹ï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨ã€‚
                    </p>
                </div>

                <div class="section">
                    <h3 class="section-title">å¸¸è§é—®é¢˜</h3>
                    <p class="section-content">
                        <strong>Q: BSC402æ˜¯ä»€ä¹ˆï¼Ÿ</strong><br>
                        A: BSC402æ˜¯FourMemeé¡¹ç›®åˆ›å»ºçš„ä»£å¸ï¼Œä¹Ÿç§°ä¸ºFourMeme402ã€‚<br><br>
                        
                        <strong>Q: ä¸ºä»€ä¹ˆé€‰æ‹©402åè®®ï¼Ÿ</strong><br>
                        A: 402æ˜¯HTTPçŠ¶æ€ç "Payment Required"ï¼Œè±¡å¾ç€æ”¯ä»˜å³æ…ˆå–„çš„ç†å¿µã€‚<br><br>
                        
                        <strong>Q: CZ402æœ‰ä»€ä¹ˆç”¨é€”ï¼Ÿ</strong><br>
                        A: CZ402æ˜¯æ…ˆå–„è´¡çŒ®è¯æ˜ï¼Œå¯äº¤æ˜“ã€å¯æä¾›æµåŠ¨æ€§ã€å¯é•¿æœŸæŒæœ‰ã€‚
                    </p>
                </div>
            `;
        }
    </script>
</body>
</html>
